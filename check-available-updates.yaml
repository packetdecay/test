---
- name: Check for available updates and report to Discord
  hosts: all
  become: true
  gather_facts: false

  vars:
    discord_webhook_url: "https://discord.com/api/webhooks/WEBHOOK-ID/WEBHOOK-TOKEN"

  tasks:

    - name: Update package cache
      apt:
        update_cache: yes
      register: apt_update

    - name: Get list of upgradable packages
      command: apt list --upgradable
      register: upgradable_raw
      changed_when: false

    - name: Filter list of upgradable packages
      set_fact:
        upgradable_packages: "{{ upgradable_raw.stdout_lines[1:] | select('match', '^[^Listing].*') | list }}"

    - name: Determine if there are updates
      set_fact:
        updates_available: "{{ upgradable_packages | length > 0 }}"

    - name: Build Discord message
      when: updates_available
      set_fact:
        discord_payload:
          content: "{{ '**' + inventory_hostname + '**\\nThe following updates are available:\\n```\\n' + (upgradable_packages | join('\\n')) + '\\n```' }}"

    - name: Send message to Discord
      when: updates_available
      uri:
        url: "{{ discord_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body: "{{ discord_payload | to_json }}"
        status_code: 204
